# Dockerfile.ui - Lightweight Streamlit UI container for cloud deployment
# Optimized for fast startup and minimal footprint

FROM python:3.11-slim

# Install only essential system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set environment variables for Python and MLflow optimization
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    MLFLOW_TRACKING_URI=http://mlflow:5000 \
    AWS_DEFAULT_REGION=us-east-2

# Set working directory
WORKDIR /app

# Install UI-required Python packages with MLflow support for model utilities
RUN pip install --no-cache-dir \
    streamlit==1.45.1 \
    requests==2.31.0 \
    pandas==2.0.3 \
    matplotlib==3.7.5 \
    plotly==5.17.0 \
    numpy==1.24.3 \
    mlflow==2.17.0 \
    boto3==1.26.0 \
    scikit-learn==1.4.0

# Copy essential application files and dependencies
COPY ui/ ./ui/
COPY apps/ml/model_utils.py ./apps/ml/model_utils.py
COPY core/ml/model_loader.py ./core/ml/model_loader.py
COPY data/exceptions.py ./data/exceptions.py
COPY data/schemas.py ./data/schemas.py

# Create required directory structure  
RUN mkdir -p apps/ml core/ml data && \
    touch apps/__init__.py apps/ml/__init__.py core/__init__.py core/ml/__init__.py data/__init__.py

# Health check for container orchestration
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Expose Streamlit port
EXPOSE 8501

# Optimized Streamlit startup command for production
CMD ["streamlit", "run", "ui/streamlit_app.py", \
     "--server.port=8501", \
     "--server.address=0.0.0.0", \
     "--server.headless=true", \
     "--server.fileWatcherType=none", \
     "--browser.gatherUsageStats=false"]